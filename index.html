<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The 5-Year Journal | 五年日記</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { paper: '#F5F0EB', ink: '#4A4036', gold: '#D4AF37', card: '#FFFFFF', subtle: '#8C857E' },
                    fontFamily: { serif: ['Merriweather', 'serif'], sans: ['Inter', 'sans-serif'] },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(74, 64, 54, 0.05)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F5F0EB; color: #4A4036; -webkit-font-smoothing: antialiased; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden-view { display: none !important; }
        .nav-btn.active { color: #4A4036; } 
        .nav-btn { color: #A8A095; transition: all 0.3s ease; }
    </style>
</head>
<body class="flex justify-center min-h-screen">

    <div class="w-full max-w-md bg-paper min-h-screen relative shadow-2xl flex flex-col overflow-hidden">

        <div id="auth-view" class="absolute inset-0 z-50 bg-paper flex flex-col justify-center items-center p-8 transition-opacity duration-500">
            <div class="w-full max-w-sm text-center">
                <div class="inline-block p-4 rounded-full border-2 border-ink/10 mb-4">
                    <i class="fa-solid fa-feather-pointed text-4xl text-ink"></i>
                </div>
                <h1 class="font-serif text-3xl font-bold text-ink mb-8">The Journal</h1>
                <div id="auth-error" class="hidden text-red-500 text-xs mb-4"></div>
                
                <form id="auth-form" class="space-y-4 text-left">
                    <input type="email" id="email" required placeholder="Email" class="w-full bg-white rounded-xl px-4 py-3 outline-none shadow-soft">
                    <input type="password" id="password" required placeholder="Password" class="w-full bg-white rounded-xl px-4 py-3 outline-none shadow-soft">
                    <button type="submit" id="auth-btn" class="w-full bg-ink text-white font-medium py-3 rounded-xl hover:bg-gold transition-colors shadow-lg">登入</button>
                </form>
                <button id="toggle-auth-mode" class="mt-6 text-xs text-subtle underline">還沒有帳號？註冊</button>
            </div>
        </div>

        <div id="app-view" class="hidden-view flex flex-col h-full opacity-0 transition-opacity duration-700">
            
            <main id="view-journal" class="flex-1 overflow-y-auto pb-24 no-scrollbar">
                
                <header class="px-4 py-6 flex justify-between items-center sticky top-0 bg-paper/95 backdrop-blur-sm z-10 border-b border-ink/5">
                    
                    <div class="flex items-center gap-2">
                        <button onclick="changeDate(-1)" class="w-8 h-8 rounded-full bg-white shadow-soft text-ink hover:text-gold transition-colors">
                            <i class="fa-solid fa-chevron-left text-xs"></i>
                        </button>
                        
                        <div class="text-center px-2 min-w-[100px]">
                            <h1 class="font-serif text-xl font-bold text-ink leading-none" id="header-date">--</h1>
                            <p class="text-[10px] text-subtle font-sans mt-1 uppercase tracking-wider" id="header-weekday">--</p>
                        </div>

                        <button onclick="changeDate(1)" class="w-8 h-8 rounded-full bg-white shadow-soft text-ink hover:text-gold transition-colors">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </button>
                    </div>

                    <button onclick="handleLogout()" class="px-3 py-1 text-xs font-bold text-ink/50 hover:text-red-500 border border-ink/10 rounded-full transition-colors">
                        登出
                    </button>
                </header>

                <section class="px-6 my-6">
                    <div class="bg-card rounded-3xl p-6 shadow-soft relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gold opacity-50"></div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold tracking-widest uppercase text-gold" id="input-year-label">2025</span>
                            <span class="text-xs text-subtle"><i class="fa-solid fa-pen-nib mr-1"></i>Writing</span>
                        </div>
                        <textarea id="journal-input" class="w-full h-32 bg-transparent border-none focus:ring-0 resize-none font-serif text-lg leading-relaxed text-ink placeholder-gray-300 p-0" placeholder="記錄下這的一刻..."></textarea>
                        <div class="flex justify-end mt-4 pt-4 border-t border-gray-100">
                            <button id="save-btn" class="bg-ink text-white px-6 py-2 rounded-full text-sm font-medium hover:bg-gold transition-colors shadow-lg">
                                保存
                            </button>
                        </div>
                    </div>
                </section>

                <section class="px-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="h-px bg-ink/10 flex-1"></div>
                        <span class="text-xs font-serif text-subtle italic">The Past</span>
                        <div class="h-px bg-ink/10 flex-1"></div>
                    </div>
                    
                    <div id="archive-list" class="flex flex-col gap-4 pb-10">
                        </div>
                </section>
            </main>

            <main id="view-profile" class="hidden-view flex-1 overflow-y-auto pb-24">
                <section class="px-6 pt-10 text-center">
                    <div class="w-20 h-20 mx-auto rounded-full bg-white shadow-soft flex items-center justify-center text-3xl text-gray-300 mb-4">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <h2 class="font-serif text-xl font-bold" id="profile-email">User</h2>
                </section>
                <div class="p-6 text-center text-sm text-subtle">統計功能開發中...</div>
            </main>

            <nav class="bg-white/90 backdrop-blur-md border-t border-gray-100 h-20 px-8 flex justify-between items-center fixed bottom-0 w-full max-w-md pb-2 z-40">
                <button id="nav-journal" class="nav-btn active flex flex-col items-center gap-1 w-16" onclick="switchTab('journal')">
                    <i class="fa-solid fa-book-open text-xl"></i><span class="text-[10px]">Journal</span>
                </button>
                <button id="nav-profile" class="nav-btn flex flex-col items-center gap-1 w-16" onclick="switchTab('profile')">
                    <i class="fa-solid fa-chart-simple text-xl"></i><span class="text-[10px]">Stats</span>
                </button>
            </nav>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ★★★ 請在此填入 API KEY ★★★
        const firebaseConfig = {
          apiKey: "AIzaSyCZw3UVcni89AWMOILc0FB9pcdQ5qQ4Fnk",
  authDomain: "journal-cfb68.firebaseapp.com",
  projectId: "journal-cfb68",
  storageBucket: "journal-cfb68.firebasestorage.app",
  messagingSenderId: "761510066058",
  appId: "1:761510066058:web:4e37165e157ce7b335fa73",
  measurementId: "G-VS6NNGZXVM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- 日期控制邏輯 (核心修改) ---
        let currentDisplayDate = new Date(); // 當前顯示的日期 (預設今天)

        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        // 更新介面日期文字
        function updateDateUI() {
            const m = months[currentDisplayDate.getMonth()];
            const d = currentDisplayDate.getDate();
            const w = days[currentDisplayDate.getDay()];
            const y = currentDisplayDate.getFullYear();

            document.getElementById('header-date').innerText = `${m} ${d}`;
            document.getElementById('header-weekday').innerText = w;
            document.getElementById('input-year-label').innerText = `${y} (Current)`;
            
            // 每次換日期，都要重抓那一天的日記
            loadEntriesForDate(); 
        }

        // 左右切換日期 (Export 給 HTML 用)
        window.changeDate = (offset) => {
            currentDisplayDate.setDate(currentDisplayDate.getDate() + offset);
            updateDateUI();
        };

        // 格式化 Month-Day (用來查詢資料庫)
        const getMDString = (date) => `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

        // --- 載入日記邏輯 (包含過去年份的空缺填補) ---
        async function loadEntriesForDate() {
            if (!currentUser) return;
            
            const listContainer = document.getElementById('archive-list');
            const inputArea = document.getElementById('journal-input');
            const targetMD = getMDString(currentDisplayDate);
            const currentYear = currentDisplayDate.getFullYear();

            // 1. 清空並顯示載入中
            listContainer.innerHTML = '<div class="text-center py-4 text-xs text-gray-300">Loading...</div>';
            inputArea.value = ""; // 清空輸入框預設值

            try {
                // 2. 從資料庫抓取「這個用戶」在「這一天 (不分年份)」的所有日記
                const q = query(
                    collection(db, "entries"),
                    where("userId", "==", currentUser.uid),
                    where("monthDay", "==", targetMD)
                );
                const snapshot = await getDocs(q);
                
                // 將資料轉換為 Map，方便按年份查找 (Key: Year, Value: Content)
                const entriesMap = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    entriesMap[data.year] = data.content;
                });

                // 3. 填入上方輸入框 (如果今年有寫過，就顯示出來讓用戶修改)
                if (entriesMap[currentYear]) {
                    inputArea.value = entriesMap[currentYear];
                }

                // 4. 生成下方「過去 5 年」的列表
                let html = '';
                // 從去年開始，往回推 5 年
                for (let i = 1; i <= 5; i++) {
                    const pastYear = currentYear - i;
                    const content = entriesMap[pastYear]; // 看看那一年有沒有日記
                    const hasContent = content ? true : false;
                    
                    // 根據是否有內容，顯示不同樣式
                    if (hasContent) {
                        html += `
                            <div class="bg-card rounded-2xl p-5 shadow-soft border border-white relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="font-serif font-bold text-xl text-ink">${pastYear}</h3>
                                    <span class="text-[10px] text-white bg-gold px-2 py-0.5 rounded-full">${months[currentDisplayDate.getMonth()]} ${currentDisplayDate.getDate()}</span>
                                </div>
                                <div class="text-sm text-[#5C5044] leading-relaxed whitespace-pre-wrap">${content}</div>
                            </div>
                        `;
                    } else {
                        // 空狀態 (Empty State) - 顯示年份但灰色
                        html += `
                            <div class="rounded-2xl p-4 border-2 border-dashed border-gray-200 flex justify-between items-center opacity-60">
                                <h3 class="font-serif font-bold text-lg text-gray-400">${pastYear}</h3>
                                <span class="text-[10px] text-gray-300">No entry</span>
                            </div>
                        `;
                    }
                }
                listContainer.innerHTML = html;

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="text-center text-red-300 text-xs">讀取失敗，請檢查網路</div>';
            }
        }

        // --- 保存邏輯 ---
        document.getElementById('save-btn').addEventListener('click', async () => {
            const content = document.getElementById('journal-input').value;
            if (!content.trim()) return;
            
            const btn = document.getElementById('save-btn');
            btn.innerText = "Saving...";

            try {
                // 這裡簡化邏輯：每次保存都視為新增一筆 Doc (實務上可能要檢查是否要 Update)
                // 但為了簡單起見，我們先用 addDoc，顯示時只抓最新的一筆即可(或是未來進階做 update)
                await addDoc(collection(db, "entries"), {
                    userId: currentUser.uid,
                    content: content,
                    year: currentDisplayDate.getFullYear(), // 使用當前選中的年份
                    monthDay: getMDString(currentDisplayDate),
                    timestamp: Timestamp.now()
                });
                
                btn.innerText = "Saved!";
                // 重新載入列表以更新畫面
                loadEntriesForDate();
                setTimeout(() => btn.innerText = "保存", 1500);
            } catch (e) {
                console.error(e);
                btn.innerText = "Error";
            }
        });

        // --- 登入/狀態管理 (維持不變) ---
        const authForm = document.getElementById('auth-form');
        let isLoginMode = true;

        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            document.getElementById('auth-btn').innerText = isLoginMode ? "登入" : "註冊";
            e.target.innerText = isLoginMode ? "還沒有帳號？註冊" : "已有帳號？登入";
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            try {
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, pw);
                else await createUserWithEmailAndPassword(auth, email, pw);
            } catch (err) {
                document.getElementById('auth-error').innerText = err.message;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        });

        window.handleLogout = () => signOut(auth);
        
        // 頁面切換
        window.switchTab = (tab) => {
            document.getElementById('view-journal').classList.toggle('hidden-view', tab !== 'journal');
            document.getElementById('view-profile').classList.toggle('hidden-view', tab !== 'profile');
            document.getElementById('nav-journal').classList.toggle('active', tab === 'journal');
            document.getElementById('nav-profile').classList.toggle('active', tab === 'profile');
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden-view');
                const appView = document.getElementById('app-view');
                appView.classList.remove('hidden-view');
                setTimeout(() => appView.classList.remove('opacity-0'), 50);
                
                updateDateUI(); // 初始化載入今天
            } else {
                currentUser = null;
                document.getElementById('auth-view').classList.remove('hidden-view');
                document.getElementById('app-view').classList.add('hidden-view', 'opacity-0');
            }
        });

    </script>
</body>
</html>